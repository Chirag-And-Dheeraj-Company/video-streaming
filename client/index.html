<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Streaming Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <main class="grid grid-cols-6">
      <form id="video-form" class="grid col-start-3 col-end-5 space-y-5">
        <div>
          <label class="block" for="title">Title</label>
          <input
            class="border w-full"
            id="title"
            type="text"
            name="title"
            value=""
          />
        </div>

        <div>
          <label class="block" for="description">Description</label>
          <textarea
            class="border w-full"
            id="description"
            type="text"
            name="description"
          ></textarea>
        </div>

        <div class="border border-black p-5">
          <!-- <button
            class="border rounded px-3 py-2 bg-indigo-500 text-white"
            id="upload"
            type="button"
          >
            Upload Video
          </button> -->
          <input id="video" class="" type="file" name="video" value="" />
        </div>

        <input
          id="uploadVideoButton"
          class="border rounded px-3 py-2 bg-indigo-500 text-white cursor-pointer"
          value="Submit"
        />
        <div id="divOutput"></div>
      </form>
    </main>
    <script>
      let uploadVideoButton = document.getElementById("uploadVideoButton");
      let divOutput = document.getElementById("divOutput");
      let video = document.getElementById("video");
      let title = document.getElementById("title");
      let description = document.getElementById("description");

      function make_id(length) {
        var result = "";
        var characters =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        var charactersLength = characters.length;
        for (var i = 0; i < length; i++) {
          result += characters.charAt(
            Math.floor(Math.random() * charactersLength)
          );
        }
        return result;
      }

      uploadVideoButton.addEventListener("click", () => {
        console.log(title.value);
        console.log(description.value);
        console.log("Read and upload button hit!");
        const fileReader = new FileReader();
        const theFile = video.files[0];

        fileReader.onload = async (ev) => {
          const CHUNK_SIZE = 5000000;
          const chunkCount = parseInt(ev.target.result.byteLength / CHUNK_SIZE);
          console.log(chunkCount);
          console.log("Read successfully");
          const fileName = make_id(7) + "_" + theFile.name;
          console.log(fileName);
          let sent = 0;
          for (let chunkID = 0; chunkID < chunkCount + 1; chunkID++) {
            console.log(chunkID);
            let chunk;
            if (chunkID == chunkCount) {
              chunk = ev.target.result.slice(chunkID * CHUNK_SIZE);
            } else {
              chunk = ev.target.result.slice(
                chunkID * CHUNK_SIZE,
                chunkID * CHUNK_SIZE + CHUNK_SIZE
              );
            }
            console.log("Chunk byteLength: ", chunk.byteLength);
            sent += chunk.byteLength;
            firstChunk = false;
            if (chunkID == 0) {
              firstChunk = true;
            }
            // reason for await is we want to wait for server's response and not flood the backend with all requests.
            const response = await fetch("http://127.0.0.1:8000/video", {
              method: "POST",
              headers: {
                "content-type": "application/octet-stream",
                "content-length": chunk.length,
                "file-name": fileName,
                "file-size": ev.target.result.byteLength,
                "first-chunk": firstChunk,
                title: title.value,
                description: description.value,
              },
              body: chunk,
            });

            console.log(await response.text());

            divOutput.textContent =
              Math.round((sent / ev.target.result.byteLength) * 100, 0) + " %";
          }
          console.log("Successfully sent " + sent + " from the client.");
        };

        fileReader.readAsArrayBuffer(theFile);
      });
    </script>
  </body>
</html>
